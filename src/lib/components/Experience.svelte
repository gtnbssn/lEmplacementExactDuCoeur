<script lang="ts">
	import { T, OrbitControls, useFrame } from '@threlte/core';
	import { Vector2 } from 'three';
	import type { ShaderMaterial } from 'three';
	import { degToRad } from 'three/src/math/MathUtils';
	import PostProcessing from '$lib/components/PostProcessing.svelte';
	import landscapeVertex from '$lib/shaders/landscapeVertex.glsl?raw';
	import landscapeFragment from '$lib/shaders/landscapeFragment.glsl?raw';
	import planeVertex from '$lib/shaders/planeVertex.glsl?raw';
	import planeFragment from '$lib/shaders/planeFragment.glsl?raw';
	import { cameraPosition, baseHue, baseHue2, baseHue3, hueSpread, saturation } from '$lib/stores';

	let landscapeMaterial: ShaderMaterial;
	let landscapeMaterial2: ShaderMaterial;
	let landscapeMaterial3: ShaderMaterial;
	let planeMaterial: ShaderMaterial;

	useFrame(({ clock }, delta) => {
		landscapeMaterial.uniforms.uTime.value += delta;
		landscapeMaterial2.uniforms.uTime.value += delta * 1.2;
		landscapeMaterial3.uniforms.uTime.value += delta * 0.8;
		landscapeMaterial.uniforms.uBaseHue.value = $baseHue;
		landscapeMaterial2.uniforms.uBaseHue.value = $baseHue2;
		landscapeMaterial3.uniforms.uBaseHue.value = $baseHue3;
		landscapeMaterial.uniforms.uHueSpread.value = $hueSpread;
		landscapeMaterial2.uniforms.uHueSpread.value = $hueSpread;
		landscapeMaterial3.uniforms.uHueSpread.value = $hueSpread;
		landscapeMaterial.uniforms.uSaturation.value = $saturation;
		landscapeMaterial2.uniforms.uSaturation.value = $saturation;
		landscapeMaterial3.uniforms.uSaturation.value = $saturation;
		planeMaterial.uniforms.uTime.value += delta;
		if (Math.floor(clock.getElapsedTime()) % 2 == 0) {
			// console.log(`beh ${clock.getElapsedTime()}`);
		}
	});
</script>

<T.Color args={['#010101']} attach="background" />
<T.PerspectiveCamera
	makeDefault
	position={[$cameraPosition.x, $cameraPosition.y, $cameraPosition.z]}
	fov={24}
>
	<OrbitControls
		maxPolarAngle={degToRad(180)}
		enableZoom={true}
		target={{ y: 0.5 }}
		enableDamping
	/>
</T.PerspectiveCamera>

<T.Mesh position={[0, 10, 0]} rotation.x={-Math.PI * 0.5}>
	<T.PlaneGeometry args={[16, 16, 128, 128]} />
	<T.ShaderMaterial
		bind:ref={landscapeMaterial3}
		vertexShader={landscapeVertex}
		fragmentShader={landscapeFragment}
		uniforms={{
			uTime: { value: 7.0 },
			uBaseHue: { value: 0.2 },
			uHueSpread: { value: 0.2 },
			uSaturation: { value: 0.5 }
		}}
	/>
</T.Mesh>

<T.Mesh position={[0, 5, 0]} rotation.x={-Math.PI * 0.5}>
	<T.PlaneGeometry args={[16, 16, 128, 128]} />
	<T.ShaderMaterial
		bind:ref={landscapeMaterial2}
		vertexShader={landscapeVertex}
		fragmentShader={landscapeFragment}
		uniforms={{
			uTime: { value: 3.0 },
			uBaseHue: { value: 0.5 },
			uHueSpread: { value: 0.2 },
			uSaturation: { value: 0.5 }
		}}
	/>
</T.Mesh>

<T.Mesh rotation.x={-Math.PI * 0.5}>
	<T.PlaneGeometry args={[16, 16, 128, 128]} />
	<T.ShaderMaterial
		bind:ref={landscapeMaterial}
		vertexShader={landscapeVertex}
		fragmentShader={landscapeFragment}
		uniforms={{
			uTime: { value: 0.0 },
			uBaseHue: { value: 0.7 },
			uHueSpread: { value: 0.2 },
			uSaturation: { value: 0.5 }
		}}
	/>
</T.Mesh>

<T.Mesh position={[0, -5, 0]} rotation.x={Math.PI * 0.5}>
	<T.PlaneGeometry args={[16, 16, 128, 128]} />
	<T.ShaderMaterial
		bind:ref={landscapeMaterial2}
		vertexShader={landscapeVertex}
		fragmentShader={landscapeFragment}
		uniforms={{
			uTime: { value: 3.0 },
			uBaseHue: { value: 0.5 },
			uHueSpread: { value: 0.2 },
			uSaturation: { value: 0.5 }
		}}
	/>
</T.Mesh>

<T.Mesh position={[0, -10, 0]} rotation.x={Math.PI * 0.5}>
	<T.PlaneGeometry args={[16, 16, 128, 128]} />
	<T.ShaderMaterial
		bind:ref={landscapeMaterial3}
		vertexShader={landscapeVertex}
		fragmentShader={landscapeFragment}
		uniforms={{
			uTime: { value: 3.0 },
			uBaseHue: { value: 0.2 },
			uHueSpread: { value: 0.2 },
			uSaturation: { value: 0.5 }
		}}
	/>
</T.Mesh>

<T.Mesh>
	<T.PlaneGeometry args={[100, 100, 32, 32]} />
	<T.ShaderMaterial
		bind:ref={planeMaterial}
		vertexShader={planeVertex}
		fragmentShader={planeFragment}
		uniforms={{ uTime: { value: 0.0 }, uFrequency: { value: new Vector2(10, 6) } }}
		wireframe
	/>
</T.Mesh>
<PostProcessing />
